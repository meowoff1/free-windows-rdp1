name: ğŸ–¥ï¸ Free Windows Desktop - VNC TigerVNC

on: 
  workflow_dispatch:

jobs:
  desktop:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ“¦ Install LocalTunnel
      run: |
        Write-Host "ğŸ“¦ Installing LocalTunnel..."
        npm install -g localtunnel
        Write-Host "âœ… LocalTunnel installed!"
      
    - name: ğŸ”§ Enable RDP (Backup)
      run: |
        Write-Host "ğŸš€ Setting up Windows..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "TigerVNC123!" -Force)
        Write-Host "âœ… Windows ready!"

    - name: ğŸ–¥ï¸ Setup TightVNC Server
      run: |
        Write-Host "ğŸ–¥ï¸ Setting up VNC Server for TigerVNC..."
        
        # Download TightVNC
        $vncUrl = "https://www.tightvnc.com/download/2.8.81/tightvnc-2.8.81-gpl-setup-64bit.msi"
        Write-Host "ğŸ“¥ Downloading TightVNC..."
        Invoke-WebRequest -Uri $vncUrl -OutFile "tightvnc.msi" -UseBasicParsing -TimeoutSec 120
        
        # Install TightVNC
        Write-Host "ğŸ”§ Installing TightVNC..."
        Start-Process msiexec.exe -Wait -ArgumentList '/i', 'tightvnc.msi', '/quiet', '/norestart', 'ADDLOCAL="Server"', 'SERVER_REGISTER_AS_SERVICE=1', 'SERVER_ADD_FIREWALL_EXCEPTION=1', 'SET_USEVNCAUTHENTICATION=1', 'VALUE_OF_USEVNCAUTHENTICATION=1', 'SET_PASSWORD=1', 'VALUE_OF_PASSWORD=tigervnc'
        
        # Start VNC service
        Start-Service "tvnserver"
        Write-Host "âœ… TightVNC Server started on port 5900!"

    - name: ğŸŒ Start VNC Tunnel
      run: |
        Write-Host "ğŸŒ Starting VNC tunnel for TigerVNC..."
        
        # Generate random subdomain
        $randomId = Get-Random -Minimum 1000 -Maximum 9999
        $subdomain = "tigervnc-$randomId"
        
        Write-Host "ğŸ”— Tunnel subdomain: $subdomain"
        
        # Start LocalTunnel for VNC port 5900
        Start-Process -FilePath "cmd" -ArgumentList "/c", "lt --port 5900 --subdomain $subdomain" -WindowStyle Hidden
        
        Write-Host "â³ Waiting for VNC tunnel to establish..."
        Start-Sleep -Seconds 15
        
        $tunnelUrl = "https://$subdomain.loca.lt"
        Write-Host "ğŸ”— VNC Tunnel URL: $tunnelUrl"
        Write-Host "ğŸ“‹ For TigerVNC: $subdomain.loca.lt:5900"

    - name: ğŸ“Š System Information
      run: |
        Write-Host "=================================="
        Write-Host "ğŸ–¥ï¸  SYSTEM INFORMATION"
        Write-Host "=================================="
        Write-Host "ğŸ’» OS: $(Get-ComputerInfo | Select-Object -ExpandProperty WindowsProductName)"
        Write-Host "ğŸ§  RAM: $([math]::Round((Get-ComputerInfo).TotalPhysicalMemory / 1GB, 2)) GB"
        Write-Host "âš¡ CPU: $(Get-ComputerInfo | Select-Object -ExpandProperty CsProcessors | Select-Object -First 1 -ExpandProperty Name)"
        Write-Host "ğŸ’¾ Disk: $([math]::Round((Get-PSDrive C | Select-Object -ExpandProperty Free) / 1GB, 2)) GB Free"
        Write-Host "=================================="

    - name: ğŸ”‘ TigerVNC Connection Details
      run: |
        Write-Host "=================================="
        Write-Host "ğŸ…  TIGERVNC CONNECTION DETAILS"
        Write-Host "=================================="
        Write-Host "ğŸŒ VNC Server: Check tunnel output above"
        Write-Host "ğŸ”Œ Port: 5900"
        Write-Host "ğŸ”‘ VNC Password: tigervnc"
        Write-Host "=================================="
        Write-Host "ğŸ“ TigerVNC Instructions:"
        Write-Host "1. Open TigerVNC Viewer"
        Write-Host "2. Enter: [tunnel-subdomain].loca.lt:5900"
        Write-Host "3. Password: tigervnc"
        Write-Host "4. Enjoy Windows Desktop!"
        Write-Host "=================================="
        Write-Host "ğŸ”„ Alternative RDP:"
        Write-Host "   Server: [tunnel-subdomain].loca.lt:3389"
        Write-Host "   Username: runneradmin"
        Write-Host "   Password: TigerVNC123!"
        Write-Host "=================================="

    - name: ğŸ”„ Keep Session Active
      run: |
        Write-Host "ğŸŸ¢ TigerVNC Session Active!"
        Write-Host "â° Started at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host "ğŸ… Connect with TigerVNC Viewer!"
        Write-Host ""
        
        $startTime = Get-Date
        $endTime = $startTime.AddHours(6)
        
        while ((Get-Date) -lt $endTime) {
            $remaining = $endTime - (Get-Date)
            $hours = [math]::Floor($remaining.TotalHours)
            $minutes = $remaining.Minutes
            
            Write-Host "ğŸŸ¢ VNC Session Active - Time Remaining: $hours hours $minutes minutes"
            Write-Host "ğŸ… TigerVNC ready for connection!"
            
            Start-Sleep -Seconds 300
        }
        
        Write-Host "â° Session ended. Run workflow again for new session!"
